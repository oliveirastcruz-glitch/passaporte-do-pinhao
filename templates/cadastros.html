<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Profissional</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background: #f7f7fa;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .cadastro-container {
            max-width: 800px;
            margin: 40px auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 40px 32px 32px 32px;
        }
        h2 {
            text-align: left;
            color: #2d3a4b;
            margin-bottom: 32px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .form-row {
            display: flex;
            gap: 24px;
            margin-bottom: 18px;
        }
        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 500;
            margin-bottom: 6px;
            color: #2d3a4b;
            padding-left: 5px;
        }
        input, select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            background: #f9fafb;
            transition: border 0.2s;
        }
        input:focus, select:focus {
            border-color: #4f8cff;
            outline: none;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 32px;
        }
        button {
            background: #4f8cff;
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #2d6be0;
        }
        .divider {
            border-top: 1px solid #e5e7eb;
            margin: 32px 0 24px 0;
        }
        .inline-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .error-message {
            color: #e53e3e;
            font-size: 0.98rem;
            margin-top: 4px;
        }
        .preview-img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 8px;
            margin-top: 6px;
        }
        @media (max-width: 700px) {
            .form-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>
<div class="cadastro-container">
    <h2>CADASTRO CLIENTE</h2>
    <form id="cadastroForm" method="POST" enctype="multipart/form-data" autocomplete="off">
        <!-- Dados Pessoais -->
        <div class="form-row">
            <div class="form-group">
                <label for="nome">Nome *</label>
                <input type="text" id="nome" name="nome" required>
            </div>
            <div class="form-group">
                <label for="sobrenome">Sobrenome *</label>
                <input type="text" id="sobrenome" name="sobrenome" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="sexo">Sexo *</label>
                <select id="sexo" name="sexo" required>
                    <option value="">Selecione</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="data_nascimento">Data de Nascimento *</label>
                <input type="text" id="data_nascimento" name="data_nascimento" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="telefone">Telefone *</label>
                <input type="text" id="telefone" name="telefone" required>
            </div>
            <div class="form-group">
                <label for="email">E-mail *</label>
                <input type="email" id="email" name="email" required>
                <div id="email-error" class="error-message"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="email2">Confirme o E-mail *</label>
                <input type="email" id="email2" name="email2" required oninput="validarEmailConfirmacao()">
                <div id="email2-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="senha">Senha *</label>
                <div style="position:relative;display:flex;align-items:center;">
                    <input type="password" id="senha" name="senha" required style="width:100%;padding-right:32px;">
                    <span onclick="toggleSenhaVisivel('senha', this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;opacity:0.6;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </span>
                </div>
                <div id="senha-strength" style="height:6px;width:100%;border-radius:4px;margin-top:4px;background:#eee;"></div>
            </div>
            <div class="form-group">
                <label for="senha2">Confirme a Senha *</label>
                <div style="position:relative;display:flex;align-items:center;">
                    <input type="password" id="senha2" name="senha2" required oninput="validarSenhaConfirmacao()" style="width:100%;padding-right:32px;">
                    <span onclick="toggleSenhaVisivel('senha2', this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;opacity:0.6;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </span>
                </div>
                <div id="senha2-error" class="error-message"></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="documento">CPF *</label>
                <input type="text" id="documento" name="documento" required onblur="verificarDocumento()">
                <div id="documento-error" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="cidade">Cidade *</label>
                <input type="text" id="cidade" name="cidade" required>
            </div>
            <div class="form-group">
                <label for="estado">Estado *</label>
                <input type="text" id="estado" name="estado" required>
            </div>
        </div>
        <div class="form-row" id="foto-pf-row">
            <div class="form-group">
                <label for="foto_pf">Foto de Perfil *</label>
                <input type="file" id="foto_pf" name="foto" accept="image/*" onchange="previewFoto(event, 'foto-preview-pf')">
                <img id="foto-preview-pf" class="preview-img" style="display:none;" />
            </div>
            <div class="form-group">
                <label for="pais">País *</label>
                <input type="text" id="pais" name="pais" required>
            </div>
        </div>
        <div class="form-row">
    </div>
        <div class="divider"></div>
        <!-- Dados da Empresa (se vendedor) -->
        <div class="form-row">
            <div class="form-group">
                <label for="tipo_usuario">Quero me cadastrar como *</label>
                <select id="tipo_usuario" name="tipo_usuario" required onchange="toggleEmpresaFields()">
                    <option value="">Selecione</option>
                    <option value="comprador">Comprador</option>
                    <option value="vendedor">Vendedor</option>
                </select>
            </div>
        </div>
        <div id="empresa-fields" style="display:none;">
            <div class="form-row">
                <div class="form-group">
                    <label for="empresa">Razão Social *</label>
                    <input type="text" id="empresa" name="empresa">
                </div>
                <div class="form-group">
                    <label for="nome_fantasia">Nome Fantasia</label>
                    <input type="text" id="nome_fantasia" name="nome_fantasia">
                </div>
                <div class="form-group">
                    <label for="cnpj">CNPJ *</label>
                    <input type="text" id="cnpj" name="cnpj" onblur="verificarCNPJ()">
                <div id="cnpj-error" class="error-message"></div>
                    <div id="cnpj-error" class="error-message"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="telefone_empresa">Telefone da Empresa *</label>
                    <input type="text" id="telefone_empresa" name="telefone_empresa">
                </div>
                <div class="form-group">
                    <label for="cidade_empresa">Cidade da Empresa *</label>
                    <select id="cidade_empresa" name="cidade_empresa">
                        <option value="">Selecione</option>
                        <option value="LAJAIKA">LAJAIKA</option>
                        {% for cidade in cidades_empresa %}
                        <option value="{{ cidade }}">{{ cidade }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="bairro">Bairro</label>
                    <input type="text" id="bairro" name="bairro">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="endereco">Endereço</label>
                    <input type="text" id="endereco" name="endereco">
                </div>
                <div class="form-group">
                    <label for="numero">Número</label>
                    <input type="text" id="numero" name="numero">
                </div>
                <div class="form-group">
                    <label for="ponto_referencia">Ponto de Referência</label>
                    <input type="text" id="ponto_referencia" name="ponto_referencia">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="min-width:220px;max-width:260px;">
                    <label for="tipo_servico">Tipo de Atendimento *</label>
                    <select id="tipo_servico" name="tipo_servico">
                        <option value="">Selecione</option>
                        <option value="local">Somente Local</option>
                        <option value="entrega">Somente Entrega</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="logo_empresa">Logo da Empresa</label>
                    <input type="file" id="logo_empresa" name="logo_empresa" accept="image/*" onchange="previewFoto(event, 'logo-preview-empresa')">
                    <img id="logo-preview-empresa" class="preview-img" style="display:none; margin-top:8px;" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1 1 100%;">
                    <label>Horário de Funcionamento *</label>
                <div style="margin-bottom:10px;display:flex;align-items:center;gap:12px;">
                    <input type="checkbox" id="aberto24h" name="aberto24h" style="width:22px;height:22px;">
                    <label for="aberto24h" style="margin-bottom:0;font-weight:600;color:#1a7f37;">Aberto 24h todos os dias</label>
                    <span id="msg-24h" style="color:#1a7f37;font-size:0.98em;display:none;margin-left:12px;">Escolha só os dias que está aberto</span>
                </div>
                    <div style="overflow-x:auto;">
                        <table id="tabela-horarios" style="width:100%; border-collapse:collapse; background:#fff;">
                            <thead>
                                <tr style="background:#f1f5fa;">
                                    <th style="padding:6px;">Dia</th>
                                    <th style="padding:6px;">Abre?</th>
                                    <th style="padding:6px;">Abre 1º</th>
                                    <th style="padding:6px;">Fecha 1º</th>
                                    <th style="padding:6px;">Abre 2º</th>
                                    <th style="padding:6px;">Fecha 2º</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set dias_abrev = ['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'] %}
                                {% for dia in dias_abrev %}
                                <tr>
                                    <td style="text-align:center; font-weight:500;">{{ dia }}</td>
                                    <td style="text-align:center;">
                                        <input type="checkbox" id="abre_{{ dia }}" name="dias_funcionamento" value="{{ dia }}" style="width:22px;height:22px;">
                                    </td>
                                    <td style="text-align:center;"><input type="time" name="horario_abre1_{{ dia }}" class="time-picker" style="width:90px;background:#f3f3f3;" value="08:00" placeholder="08:00"></td>
                                    <td style="text-align:center;"><input type="time" name="horario_fecha1_{{ dia }}" class="time-picker" style="width:90px;background:#f3f3f3;" value="12:00" placeholder="12:00"></td>
                                    <td style="text-align:center;"><input type="time" name="horario_abre2_{{ dia }}" class="time-picker" style="width:90px;background:#f3f3f3;" value="14:00" placeholder="14:00"></td>
                                    <td style="text-align:center;"><input type="time" name="horario_fecha2_{{ dia }}" class="time-picker" style="width:90px;background:#f3f3f3;" value="18:00" placeholder="18:00"></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <small style="color:#888; margin-top:10px; display:block;">Marque os dias que abre e defina até 2 turnos de horário para cada dia.</small>
                </div>
            </div>
            <div class="form-row">
            <!-- Removido campos de horários especiais e turnos extras -->
            </div>
        </div>
        <div class="divider"></div>
        <div class="form-row">
            <div style="display: flex; align-items: center; width: 100%;">
                <div class="inline-check" style="flex:1; justify-content: flex-start;">
                    <input type="checkbox" id="aceitar_termos" name="aceitar_termos" required style="width:18px;height:18px;">
                    <label for="aceitar_termos" style="margin-bottom:0;">Li e aceito os <a href="#" target="_blank">Termos de Uso</a> *</label>
                </div>
                <div class="form-actions" style="flex:1; justify-content: flex-end;">
                    <button type="submit">Finalizar Cadastro</button>
                </div>
            </div>
        </div>
    </form>
    <!-- Modal flutuante para e-mail já cadastrado -->
    <!-- Modal flutuante para CPF já cadastrado -->
    <div id="modal-cpf-existe" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.18);max-width:350px;width:90vw;text-align:center;position:relative;">
            <span style="position:absolute;top:8px;right:16px;font-size:22px;cursor:pointer;" onclick="fecharModalCpfExiste()">&times;</span>
            <h2 style="color:#dc3545;margin-bottom:12px;">CPF já cadastrado!</h2>
            <p>Deseja recuperar a senha ou tentar outro CPF?</p>
            <div style="margin-top:18px;display:flex;gap:12px;justify-content:center;">
                <a href="/esqueci-senha" style="background:#007bff;color:#fff;padding:8px 16px;border-radius:4px;text-decoration:none;">Recuperar senha</a>
                <button onclick="fecharModalCpfExiste()" style="background:#6c757d;color:#fff;padding:8px 16px;border:none;border-radius:4px;">Tentar outro</button>
            </div>
        </div>
    </div>
    <!-- Modal flutuante para CNPJ já cadastrado -->
    <div id="modal-cnpj-existe" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.18);max-width:350px;width:90vw;text-align:center;position:relative;">
            <span style="position:absolute;top:8px;right:16px;font-size:22px;cursor:pointer;" onclick="fecharModalCnpjExiste()">&times;</span>
            <h2 style="color:#dc3545;margin-bottom:12px;">CNPJ já cadastrado!</h2>
            <p>Deseja recuperar a senha ou tentar outro CNPJ?</p>
            <div style="margin-top:18px;display:flex;gap:12px;justify-content:center;">
                <a href="/esqueci-senha" style="background:#007bff;color:#fff;padding:8px 16px;border-radius:4px;text-decoration:none;">Recuperar senha</a>
                <button onclick="fecharModalCnpjExiste()" style="background:#6c757d;color:#fff;padding:8px 16px;border:none;border-radius:4px;">Tentar outro</button>
            </div>
        </div>
    </div>
    <div id="modal-email-existe" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.18);max-width:350px;width:90vw;text-align:center;position:relative;">
            <span style="position:absolute;top:8px;right:16px;font-size:22px;cursor:pointer;" onclick="fecharModalEmailExiste()">&times;</span>
            <h2 style="color:#dc3545;margin-bottom:12px;">E-mail já cadastrado!</h2>
            <p>Deseja recuperar a senha ou tentar outro e-mail?</p>
            <div style="margin-top:18px;display:flex;gap:12px;justify-content:center;">
                <a href="/esqueci-senha" style="background:#007bff;color:#fff;padding:8px 16px;border-radius:4px;text-decoration:none;">Recuperar senha</a>
                <button onclick="fecharModalEmailExiste()" style="background:#6c757d;color:#fff;padding:8px 16px;border:none;border-radius:4px;">Tentar outro</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// Lógica do botão 24h e cor das linhas
const chk24h = document.getElementById('aberto24h');
const tabelaHorarios = document.getElementById('tabela-horarios');
const msg24h = document.getElementById('msg-24h');
function atualizarCoresHorarios() {
    tabelaHorarios.querySelectorAll('tbody tr').forEach(function(tr) {
        const chk = tr.querySelector('input[type="checkbox"]');
        if (chk && chk.checked) {
            if (chk24h.checked) {
                tr.style.background = '#e3f7e8'; // verde
            } else {
                tr.style.background = '#b91c1c'; // vermelho escuro
            }
        } else {
            tr.style.background = '';
        }
    });
    msg24h.style.display = chk24h.checked ? 'inline' : 'none';
}
chk24h.addEventListener('change', atualizarCoresHorarios);
tabelaHorarios.querySelectorAll('input[type="checkbox"]').forEach(function(chk) {
    chk.addEventListener('change', atualizarCoresHorarios);
});
// Estado inicial
atualizarCoresHorarios();
</script>
<script>
// Olho discreto para ver senha
function toggleSenhaVisivel(id, el) {
    var input = document.getElementById(id);
    if (input.type === 'password') {
        input.type = 'text';
        el.style.opacity = 1;
    } else {
        input.type = 'password';
        el.style.opacity = 0.6;
    }
}
</script>
<script>
// Olho para ver senha (SVG)
function toggleSenhaVisivel(id, btn) {
    var input = document.getElementById(id);
    var svg = btn.querySelector('svg');
    if (input.type === 'password') {
        input.type = 'text';
        svg.style.opacity = 0.5;
    } else {
        input.type = 'password';
        svg.style.opacity = 1;
    }
}
// Destacar linha de horário quando aberto
document.querySelectorAll('#tabela-horarios input[type="checkbox"]').forEach(function(chk) {
    chk.addEventListener('change', function() {
        var tr = chk.closest('tr');
        if (chk.checked) {
            tr.style.background = '#e3f7e8';
        } else {
            tr.style.background = '';
        }
    });
    // Estado inicial
    if (chk.checked) {
        chk.closest('tr').style.background = '#e3f7e8';
    }
});
</script>
<script>
// Modal CPF/CNPJ igual ao do e-mail
const documentoInput = document.getElementById('documento');
const documentoErrorDiv = document.getElementById('documento-error');
const modalCpfExiste = document.getElementById('modal-cpf-existe');
let cpfExiste = false;
if(documentoInput) {
    documentoInput.addEventListener('input', function () {
        const doc = documentoInput.value.trim();
        if (doc.length === 11 && /^\d{11}$/.test(doc)) {
            fetch('/verifica_existente', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'tipo=cpf&valor=' + encodeURIComponent(doc)
            })
            .then(r => r.json())
            .then(data => {
                if (data.existe) {
                    documentoErrorDiv.innerHTML = 'CPF já cadastrado! <a href="/esqueci-senha" style="color:#007bff;text-decoration:underline;">Recuperar senha</a>';
                    documentoInput.style.borderColor = 'red';
                    cpfExiste = true;
                    documentoInput.setAttribute('data-existe', '1');
                    modalCpfExiste.style.display = 'flex';
                } else {
                    documentoErrorDiv.textContent = '';
                    documentoInput.style.borderColor = '';
                    cpfExiste = false;
                    documentoInput.removeAttribute('data-existe');
                    modalCpfExiste.style.display = 'none';
                }
            });
        } else if (doc.length === 14 && /^\d{14}$/.test(doc)) {
            // CNPJ
            fetch('/verifica_existente', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'tipo=cnpj&valor=' + encodeURIComponent(doc)
            })
            .then(r => r.json())
            .then(data => {
                if (data.existe) {
                    documentoErrorDiv.innerHTML = 'CNPJ já cadastrado! <a href="/esqueci-senha" style="color:#007bff;text-decoration:underline;">Recuperar senha</a>';
                    documentoInput.style.borderColor = 'red';
                    cpfExiste = true;
                    documentoInput.setAttribute('data-existe', '1');
                    modalCnpjExiste.style.display = 'flex';
                } else {
                    documentoErrorDiv.textContent = '';
                    documentoInput.style.borderColor = '';
                    cpfExiste = false;
                    documentoInput.removeAttribute('data-existe');
                    modalCnpjExiste.style.display = 'none';
                }
            });
        } else {
            documentoErrorDiv.textContent = '';
            documentoInput.style.borderColor = '';
            cpfExiste = false;
            documentoInput.removeAttribute('data-existe');
            modalCpfExiste.style.display = 'none';
            modalCnpjExiste.style.display = 'none';
        }
    });
}
function fecharModalCpfExiste() {
    modalCpfExiste.style.display = 'none';
    documentoInput.value = '';
    documentoInput.style.borderColor = '';
    documentoErrorDiv.textContent = '';
    documentoInput.removeAttribute('data-existe');
    cpfExiste = false;
    documentoInput.focus();
}
const cnpjInput = document.getElementById('cnpj');
const cnpjErrorDiv = document.getElementById('cnpj-error');
const modalCnpjExiste = document.getElementById('modal-cnpj-existe');
let cnpjExiste = false;
if(cnpjInput) {
    cnpjInput.addEventListener('input', function () {
        const cnpj = cnpjInput.value.trim();
        if (cnpj.length === 14 && /^\d{14}$/.test(cnpj)) {
            fetch('/verifica_existente', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'tipo=cnpj&valor=' + encodeURIComponent(cnpj)
            })
            .then(r => r.json())
            .then(data => {
                if (data.existe) {
                    cnpjErrorDiv.innerHTML = 'CNPJ já cadastrado! <a href="/esqueci-senha" style="color:#007bff;text-decoration:underline;">Recuperar senha</a>';
                    cnpjInput.style.borderColor = 'red';
                    cnpjExiste = true;
                    cnpjInput.setAttribute('data-existe', '1');
                    modalCnpjExiste.style.display = 'flex';
                } else {
                    cnpjErrorDiv.textContent = '';
                    cnpjInput.style.borderColor = '';
                    cnpjExiste = false;
                    cnpjInput.removeAttribute('data-existe');
                    modalCnpjExiste.style.display = 'none';
                }
            });
        } else {
            cnpjErrorDiv.textContent = '';
            cnpjInput.style.borderColor = '';
            cnpjExiste = false;
            cnpjInput.removeAttribute('data-existe');
            modalCnpjExiste.style.display = 'none';
        }
    });
}
function fecharModalCnpjExiste() {
    modalCnpjExiste.style.display = 'none';
    cnpjInput.value = '';
    cnpjInput.style.borderColor = '';
    cnpjErrorDiv.textContent = '';
    cnpjInput.removeAttribute('data-existe');
    cnpjExiste = false;
    cnpjInput.focus();
}
// Barra de força da senha
const senhaInput = document.getElementById('senha');
const senhaStrength = document.getElementById('senha-strength');
if(senhaInput && senhaStrength) {
    senhaInput.addEventListener('input', function() {
        const val = senhaInput.value;
        let score = 0;
        if(val.length >= 6) score++;
        if(/[!@#$%^&*(),.?":{}|<>]/.test(val)) score++;
        if(/[A-Z]/.test(val)) score++;
        if(/[0-9]/.test(val)) score++;
        if(val.length >= 10) score++;
        let color = '#e53e3e', text = 'Fraca';
        if(score >= 4) { color = '#38a169'; text = 'Forte'; }
        else if(score >= 2) { color = '#f6ad55'; text = 'Média'; }
        senhaStrength.style.background = color;
        senhaStrength.title = text;
    });
}
// Validação de e-mail, senha, termos no submit
document.getElementById('cadastroForm').addEventListener('submit', function(e) {
    // Validações desativadas temporariamente para debug
});
</script>
<script>
// Robustez: mostra modal e bloqueia submit se e-mail já cadastrado
const emailInput = document.getElementById('email');
const emailErrorDiv = document.getElementById('email-error');
const modalEmailExiste = document.getElementById('modal-email-existe');
let emailExiste = false;
if(emailInput) {
    emailInput.addEventListener('input', function () {
        const email = emailInput.value.trim();
        if (email.length > 5 && email.includes('@')) {
            fetch('/verifica_existente', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'tipo=email&valor=' + encodeURIComponent(email)
            })
            .then(r => r.json())
            .then(data => {
                if (data.existe) {
                    emailErrorDiv.innerHTML = 'E-mail já cadastrado! <a href="/esqueci-senha" style="color:#007bff;text-decoration:underline;">Recuperar senha</a>';
                    emailInput.style.borderColor = 'red';
                    emailExiste = true;
                    emailInput.setAttribute('data-existe', '1');
                    // Mostra modal imediatamente
                    modalEmailExiste.style.display = 'flex';
                } else {
                    emailErrorDiv.textContent = '';
                    emailInput.style.borderColor = '';
                    emailExiste = false;
                    emailInput.removeAttribute('data-existe');
                    modalEmailExiste.style.display = 'none';
                }
            });
        } else {
            emailErrorDiv.textContent = 'Digite um e-mail válido.';
            emailInput.style.borderColor = 'red';
            emailExiste = false;
            emailInput.removeAttribute('data-existe');
            modalEmailExiste.style.display = 'none';
        }
    });
    document.getElementById('cadastroForm').addEventListener('submit', function(e) {
        const email = emailInput.value.trim();
        if (!email || !email.includes('@')) {
            emailErrorDiv.textContent = 'Digite um e-mail válido.';
            emailInput.style.borderColor = 'red';
            e.preventDefault();
            return false;
        }
        if (emailInput.getAttribute('data-existe') === '1' || emailExiste) {
            emailErrorDiv.innerHTML = 'E-mail já cadastrado! <a href="/esqueci-senha" style="color:#007bff;text-decoration:underline;">Recuperar senha</a>';
            emailInput.style.borderColor = 'red';
            modalEmailExiste.style.display = 'flex';
            e.preventDefault();
            return false;
        }
        // Previne submit duplo
        this.querySelector('button[type="submit"]').disabled = true;
        return true;
    });
}
function fecharModalEmailExiste() {
    modalEmailExiste.style.display = 'none';
    emailInput.value = '';
    emailInput.style.borderColor = '';
    emailErrorDiv.textContent = '';
    emailInput.removeAttribute('data-existe');
    emailExiste = false;
    emailInput.focus();
}
</script>
<script>
    flatpickr('#data_nascimento', {dateFormat: 'Y-m-d'});
    flatpickr('.time-picker', {enableTime: true, noCalendar: true, dateFormat: 'H:i', time_24hr: true});
    flatpickr('.time-range-picker', {enableTime: true, noCalendar: true, mode: 'range', dateFormat: 'H:i', time_24hr: true});
    function toggleEmpresaFields() {
        var tipo = document.getElementById('tipo_usuario').value;
        var empresaFields = document.getElementById('empresa-fields');
        var fotoPfRow = document.getElementById('foto-pf-row');
        if (tipo === 'vendedor') {
            empresaFields.style.display = 'block';
            fotoPfRow.style.display = 'none';
            ['empresa','cnpj','telefone_empresa','cidade_empresa','tipo_servico'].forEach(function(id) {
                document.getElementById(id).required = true;
            });
        } else {
            empresaFields.style.display = 'none';
            fotoPfRow.style.display = 'flex';
            ['empresa','cnpj','telefone_empresa','cidade_empresa','tipo_servico'].forEach(function(id) {
                document.getElementById(id).required = false;
            });
        }
    }
    function previewFoto(event, previewId) {
        var output = document.getElementById(previewId);
        output.src = URL.createObjectURL(event.target.files[0]);
        output.style.display = 'block';
    }
    function verificarEmail() {
        var email = document.getElementById('email').value;
        if (!email) return;
        fetch('/verifica_existente', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'tipo=email&valor=' + encodeURIComponent(email)
        })
        .then(res => res.json())
        .then(data => {
            var erro = document.getElementById('email-error');
            if (data.existe) {
                erro.textContent = 'E-mail já cadastrado.';
            } else {
                erro.textContent = '';
            }
        });
    }
    function verificarDocumento() {
        var doc = document.getElementById('documento').value;
        if (!doc) return;
        fetch('/verifica_existente', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'tipo=cpf&valor=' + encodeURIComponent(doc)
        })
        .then(res => res.json())
        .then(data => {
            var erro = document.getElementById('documento-error');
            if (data.existe) {
                erro.textContent = 'CPF já cadastrado.';
            } else {
                erro.textContent = '';
            }
        });
    }
    function verificarCNPJ() {
        var cnpj = document.getElementById('cnpj').value;
        if (!cnpj) return;
        fetch('/verifica_existente', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'tipo=cnpj&valor=' + encodeURIComponent(cnpj)
        })
        .then(res => res.json())
        .then(data => {
            var erro = document.getElementById('cnpj-error');
            if (data.existe) {
                erro.textContent = 'CNPJ já cadastrado.';
            } else {
                erro.textContent = '';
            }
        });
    }
    function validarEmailConfirmacao() {
        var email = document.getElementById('email').value;
        var email2 = document.getElementById('email2').value;
        var erro = document.getElementById('email2-error');
        if (email2 && email !== email2) {
            erro.textContent = 'Os e-mails não coincidem.';
        } else {
            erro.textContent = '';
        }
    }
    function validarSenhaConfirmacao() {
        var senha = document.getElementById('senha').value;
        var senha2 = document.getElementById('senha2').value;
        var erro = document.getElementById('senha2-error');
        if (senha2 && senha !== senha2) {
            erro.textContent = 'As senhas não coincidem.';
        } else {
            erro.textContent = '';
        }
    }
    document.getElementById('cadastroForm').onsubmit = function(e) {
        if (document.getElementById('email-error').textContent ||
            document.getElementById('email2-error').textContent ||
            document.getElementById('senha2-error').textContent ||
            document.getElementById('documento-error').textContent ||
            document.getElementById('cnpj-error').textContent) {
            e.preventDefault();
            alert('Corrija os erros antes de enviar o formulário.');
        }
    };
</script>
<style>
    .dia-chip {
        background: #f1f5fa;
        border-radius: 16px;
        padding: 4px 12px;
        margin: 2px 0;
        font-weight: 500;
        border: 1px solid #d1d5db;
        transition: background 0.2s, border 0.2s;
        cursor: pointer;
    }
    .dia-chip input[type="checkbox"] {
        margin-right: 4px;
    }
    .dia-chip input[type="checkbox"]:checked + label {
        background: #4f8cff;
        color: #fff;
        border-color: #4f8cff;
    }
</style>
</body>
</html>
